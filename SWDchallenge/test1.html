<!DOCTYPE html>

<html>
<head>
  <meta charset="utf-8">

  <!-- Load d3.js -->
  <script src="https://d3js.org/d3.v4.js"></script>

</head>
<body>
  <div class="chart"></div>
  <script>

    var margin = { top: 10, right: 10, bottom: 40, left: 80 },
    width = 1260 - margin.left - margin.right,
    height = 660 - margin.top - margin.bottom;

    var lineGenerator = d3.line()
        .x(d => x(d.x))
        .y(d => y(d.y))

    d3.csv("./data/all_country_agg.csv",function(error, data) {

      data.forEach(function(d) {
        d.x = d.group
        d.y = +d.value
      });

      // A color scale: one color for each country
      var myColor = d3.scaleOrdinal()
        .domain(data.map(d=>d.country).filter(onlyUnique))
        .range(d3.schemeCategory10); 

      x = d3.scaleBand()
          .domain(data.map(d=>d.x).filter(onlyUnique))
          .range([margin.left, width - margin.right])

      y = d3.scaleSqrt()
          .domain(d3.extent(data, d => d.y)).nice()
          .range([height - margin.bottom, margin.top])

      xAxis = g => g
          .attr("transform", `translate(${- x.bandwidth()/2},${height - margin.bottom})`)
          .call(d3.axisBottom(x).ticks(width / 80))
          .call(g => g.select(".domain").remove())
          .call(g => g.selectAll(".tick line").clone()
              .attr("y2", -height)
              .attr("stroke-opacity", 0.1))
          .call(g => g.append("text")
              .attr("x", width - 4)
              .attr("y", -4)
              .attr("font-weight", "bold")
              .attr("text-anchor", "end")
              .attr("fill", "black")
              .text(data.x))

      yAxis = g => g
          .attr("transform", `translate(${margin.left},0)`)
          .call(d3.axisLeft(y).ticks(null, "$.2f"))
          .call(g => g.select(".domain").remove())
          .call(g => g.selectAll(".tick line").clone()
              .attr("x2", width)
              .attr("stroke-opacity", 0.1))
          .call(g => g.select(".tick:last-of-type text").clone()
              .attr("x", 4)
              .attr("text-anchor", "start")
              .attr("font-weight", "bold")
              .attr("fill", "black")
              .text(data.y))

      var svg = d3.select(".chart")
        .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      svg.append("g")
          .call(xAxis);
      
      svg.append("g")
          .call(yAxis);

      var dataReady = d3.nest() // necessary to nest data so that keys represent each category
        .key(d=>d.country)
        .entries(data)
      console.log(dataReady)
      svg.selectAll("myLines")
        .data(dataReady)
        .enter()
        .append("path")
          .attr("d", function(d){ return lineGenerator(d.values) } )
          .attr("stroke", function(d){ return myColor(d.key) })
          .style("stroke-width", 1.5)
          .style("fill", "none")

      // Add the points
      svg
        // First we need to enter in a group
        .selectAll("myDots")
        .data(dataReady)
        .enter()
          .append('g')
          .style("fill", function(d){ return myColor(d.key) })
        // Second we need to enter in the 'values' part of this group
        .selectAll("myPoints")
        .data(function(d){ return d.values })
        .enter()
        .append("circle")
          .attr("cx", function(d) { return x(d.x) } )
          .attr("cy", function(d) { return y(d.y) } )
          .attr("r", 3)
          .attr("stroke", "white")

    })

    function onlyUnique(value, index, self) { 
        return self.indexOf(value) === index;
    }

  </script>
</body>
</html>