<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://cdn.jsdelivr.net/npm/vega@4.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@3.0.0-rc6"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@3.19.2"></script>
  <script src="https://d3js.org/d3.v4.min.js" type="text/javascript"></script>
  <script
    src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
  <script src="../vendor/semantic/semantic.min.js"></script>
  <link rel="stylesheet" type="text/css" href="../vendor/semantic/semantic.min.css">

</head>

<body>
  <div class='wrapper'>
    <div class='container'>

      <div id='main'>
        <div id='chart'></div>
        <div id='heatmap1'></div>
        <div id='heatmap2'></div>
      </div>

    </div>
  </div>

  <script>
    var beeswarm = function () {

      ///////////////////////////////////////////////////////////////////////////
      ///////////////////////////////// Globals /////////////////////////////////
      /////////////////////////////////////////////////////////////////////////// 

      var svg, nodes
      var canvasDim = { width: 1200, height: 600}
      var margin = {top: 0, right: 20, bottom: 20, left: 20}
      var width = canvasDim.width - margin.left - margin.right
      var height = canvasDim.height - margin.top - margin.bottom
      var modal = d3.select("#chart")

      ///////////////////////////////////////////////////////////////////////////
      ///////////////////////////// Create scales ///////////////////////////////
      ///////////////////////////////////////////////////////////////////////////

      var xScale = d3.scaleLinear()
        .range([0, width])

      var colorScale = d3.scaleOrdinal()
        .domain(["No", "Yes"])
        .range(['#f0f0f0','#000000'])

      var rScale = d3.scaleSqrt()
        .range([2, 30])

      ///////////////////////////////////////////////////////////////////////////
      ////////////////////// Initialize force simulation ////////////////////////
      ///////////////////////////////////////////////////////////////////////////

      var simulation = d3.forceSimulation()  
        .force("x", d3.forceX(function(d) { return xScale(d.value.avg) }).strength(0.8))
        .force("y", d3.forceY(height / 2))
        .force("collide", d3.forceCollide(function(d,i) { return rScale(d.value.count)+2 }))
        .stop()

      function init() {
        d3.queue()   
          .defer(d3.csv, './data/cleaned_survey_results_filtered.csv')
          .defer(d3.csv, './data/grouped_level.csv') 
          .defer(d3.csv, './data/grouped_modes.csv') 
          .await(processData); 
      }

      function processData(error, csv, csv2, csv3) {

        var valueScore = d3.nest()
          .key(function(d) { return d.country; })
          .rollup(function(v) { return {
            count: v.length,
            avg: d3.mean(v, function(d) { return d.value; })

          }; })
          .entries(csv)

        csv2.map(d=>{
          d.percLabel = +d.perc >= 50 ? "Yes" : "No"
        })
        valueScore.map(d=>{
          d.levelPerc = csv2.find(el=>el.country == d.key) ? csv2.find(el=>el.country == d.key).percLabel : "No"
        })
        xScale.domain(d3.extent(valueScore, d=>d.value.avg))
        rScale.domain(d3.extent(valueScore, d=>d.value.count))

        //////////////////////// Kick off simulation //////////////////////////////
        simulation.nodes(valueScore.flat())
        for (var i = 0; i < 500; ++i) simulation.tick() // let simulation run in the background

        update(valueScore.flat())

        var modes = d3.nest()
          .key(d=>d['role'])
          .key(d=>d['mode'])
          .rollup(function(leaves) { return d3.sum(leaves, function(d) {return +d.values})} )
          .entries(csv3)

        var flatModes = []
        modes.forEach(function(mode) {
          mode.values.forEach(function(m) {
            flatModes.push({
              role: mode.key,
              mode: m.key,
              value: +m.value,
            });
          });
        });
        createHeatMap(flatModes, 'mode', 'role', 'heatmap1')

        var levels = d3.nest()
          .key(d=>d['role'])
          .key(d=>d['level'])
          .rollup(function(leaves) { return leaves.length })
          .entries(csv)

        var levels1 = d3.nest()
          .key(d=>d['role'])
          .rollup(function(leaves) { return leaves.length })
          .entries(csv)

        var flatLevels = []
        levels.forEach(function(level) {
          var total = levels1.find(el=>el.key==level.key).value
          level.values.forEach(function(l) {
            flatLevels.push({
              role: level.key,
              level: l.key,
              value: Math.round( +l.value/total * 100 ) / 100
            });
          });
        });   
         
        createHeatMap(flatLevels, 'level', 'role', 'heatmap2')

      }
      ///////////////////////////////////////////////////////////////////////////
      ////////////////////////////////// CORE  //////////////////////////////////
      ///////////////////////////////////////////////////////////////////////////

      return { 
        run : function () {
          //////////////////// Set up and initiate containers ///////////////////////
          svg = modal.append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          nodes = svg.append('g')
            .attr('class', 'nodes')

          ///////////////////////// Data processing ////////////////////////////////
          init()

        }
      }

      function update(data) {

        var groups = nodes.selectAll('.node-group').data(data) // join data with new x-y coordinates after force layout does its magic on it

        var groupsEnter = groups.enter().append("g")
          .attr("class", function(d,i) { return "node-" + i})

        groupsEnter.merge(groups)
            .attr('transform', (d, i) =>
              `translate(${d.x},${d.y})` 
            ); 

        groups.exit().remove();

        groupsEnter.append('circle')
          .merge(groups.select('circle'))
            .transition()
            .attr('r', function (d) { return rScale(d.value.count) })
            .attr('stroke', function(d) { return colorScale(d.levelPerc) })
            .attr("fill", function(d) { return colorScale(d.levelPerc) })
            .attr('fill-opacity', 1)

        // AXES // 
        var xAxis = d3.axisBottom(xScale).tickSizeOuter(0).tickSizeInner(0)

        var x_axis = nodes.append("g").attr("class", "x_axis")
          .attr("transform", "translate(" + 0 + "," + (height/2+40).toString() + ")") 
          .call(xAxis)

      }

      function createHeatMap(data, X, Y, id) {

        var rect = document.getElementById(id).getBoundingClientRect();
        w = rect.width * 0.75;
        h = rect.height * 0.8;

        var yourVlSpec1 = 
          {
            "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
            "data": {"values": data},
            "encoding": {
              "y": {"field": Y, "type": "ordinal"},
              "x": {"field": X, "type": "ordinal"}
            },
            "layer": [
              {
                "mark": "rect",
                "encoding": {
                  "color": {
                    "field": "value",
                    "type": "quantitative",
                    "title": "Count of Records",
                    "scale": {
                      "domain": [0, 0.6],
                      "range": ["#fff", "#000"],
                    },
                    "legend": {"direction": "horizontal", "gradientLength": 120}
                  }
                }
              },
              {
                "mark": "text",
                "encoding": {
                  "text": {"field": "value", "type": "quantitative"},
                  "color": {
                    "condition": {"test": "datum['value'] > 300", "value": "black"},
                    "value": "white"
                  }
                }
              }
            ],
            "config": {
              "scale": {"bandPaddingInner": 0, "bandPaddingOuter": 0},
              "text": {"baseline": "middle"}
            }
          }
        vegaEmbed('#'+id, yourVlSpec1);

      }
     

    }()

    beeswarm.run()

  </script>
</body>
</html>