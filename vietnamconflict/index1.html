<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="http://d3js.org/d3.v4.min.js" type="text/javascript"></script>
    <link href="../css/global.css" rel="stylesheet">

    <style>
      .label { font-size: 1rem; }
    </style>
  </head>

  <body>
    <div class="App">
        <h1>Vietnam War Bloodshed</h1> 
        <div id="my_dataviz"></div>
    <script type="text/javascript">

    // Do the loop
    loop(); 
    setInterval(loop, 15000);
    
    function loop() {
      disperseBlob();
      //setTimeout(clusterProvince, 7000);
      //setTimeout(backToCenter, 12000);
    }

    // set the dimensions and margins of the graph
    var margin = {top: 60, right: 30, bottom: 20, left:110},
        width = 960 - margin.left - margin.right,
        height = 900 - margin.top - margin.bottom;

    // append the svg object to the body of the page
    var svg = d3.select("#my_dataviz")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");

    //SVG filter for the gooey effect
    //Code taken from http://tympanus.net/codrops/2015/03/10/creative-gooey-effects/
    var defs = svg.append("defs");
    var filter = defs.append("filter").attr("id","gooeyCodeFilter");
    filter.append("feGaussianBlur")
      .attr("in","SourceGraphic")
      .attr("stdDeviation","20")
      //to fix safari: http://stackoverflow.com/questions/24295043/svg-gaussian-blur-in-safari-unexpectedly-lightens-image
      .attr("color-interpolation-filters","sRGB") 
      .attr("result","blur");
    filter.append("feColorMatrix")
      .attr("class", "blurValues")
      .attr("in","blur")
      .attr("mode","matrix")
      .attr("values","1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -5")
      .attr("result","gooey");
    filter.append("feBlend")
      .attr("in","SourceGraphic")
      .attr("in2","gooey")
      .attr("operator","atop");

    //Mimick splitting the large goo from the center to individual locations of bubbles on scatterplot
    function disperseBlob () {
      //read data
      d3.csv("./data/VietnamConflict1.csv", function(data) {

        // parse the date / time
        var parseMonth = d3.timeParse("%b");

        // format the data
        data.forEach(function(d) {
          d.FATALITY_MONTH = parseMonth(d.FATALITY_MONTH);
        });

        // Add X axis
        var xScale = d3.scaleTime()
          .domain(d3.extent(data, function(d){return d.FATALITY_MONTH}))
          .rangeRound([20, width])

        svg.append("g")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(xScale).tickFormat(d3.timeFormat("%b")));

        // Create the Y axis for names
        var yScale = d3.scaleLinear()
          .domain(d3.extent(data, function(d){return d.FATALITY_YEAR})).nice()
          .range([0, height-20])

        svg.append("g")
          .call(d3.axisLeft(yScale));

        // square root scale.
        var radius = d3.scaleSqrt()
          .domain(d3.extent(data, function(d){return d.count}))
          .range([0, 16]);

        //Wrapper for the big blob of goo
        var deathWrapper = svg.append("g")
          .attr("class", "wrapper")
          .style("filter", "url(#gooeyCodeFilter)");

        var coverCirleRadius = 80;
        //Circle over all others
        deathWrapper.append("circle")
          .attr("class", "scatterplotCover")
          .attr("r", coverCirleRadius)
          .attr("cx", width/2)
          .attr("cy", height/2)
          .attr("fill", "red")

        // Add areas
        deathWrapper.selectAll(".bubbles")
          .data(data)
          .enter()
          .append("circle")
            .attr('class', 'bubbles')
            .attr('cx', width/2)
            .attr('cy', height/2)
            .attr('r', function(d){ return radius(d.count); })
            .attr("fill", "red")

        //Make the cover circle shrink
        deathWrapper.selectAll(".scatterplotCover")
            .transition().duration(5000)
            .attr("r", 0);

        //Put the cities in their location on scatterplot
        deathWrapper.selectAll(".bubbles")
          .transition("move").duration(2000)
          .delay(function(d,i) { return i*20; })
          .attr("r", function(d) {
            return d.radius = radius(d.count);
          })
          .attr("cx", function(d) {
            return d.x = xScale(d.FATALITY_MONTH);
          })
          .attr("cy", function(d) {
            return d.y = yScale(d.FATALITY_YEAR);
          });
      
        //"Remove" gooey filter from cities during the transition
        //So at the end they do not appear to melt together anymore
        d3.selectAll(".blurValues")
          .transition().duration(4000)
          .attrTween("values", function() { 
            return d3.interpolateString("1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -5", 
                          "1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 6 -5"); 
          });

      })

    }  

    </script>
  </body>

</html>